# Enhanced Digest System Setup

The digest system has been enhanced with several new features:

## Features Added

1. **User-configurable digest delivery times** (max 2 per day, default 11am/9pm)
2. **Email filtering options** (all emails or important emails only)
3. **ChatGPT integration** for email summaries in digests
4. **Email delivery system** for sending digests via email
5. **Digest history and archive** functionality with web interface

## Environment Variables

Add these environment variables to your `.env` file:

```bash
# Email delivery configuration (required for email digests)
EMAIL_SERVICE=gmail                    # or 'smtp' for custom SMTP
EMAIL_USER=your-email@gmail.com       # Gmail address or SMTP username
EMAIL_PASSWORD=your-app-password      # Gmail App Password or SMTP password
EMAIL_FROM=your-email@gmail.com       # From address (optional, defaults to EMAIL_USER)

# For custom SMTP (if EMAIL_SERVICE=smtp)
SMTP_HOST=smtp.yourdomain.com
SMTP_PORT=587

# OpenAI configuration (required for email summaries)
OPENAI_API_KEY=your-openai-api-key    # Already configured
OPENAI_SUMMARY_MODEL=gpt-3.5-turbo   # Optional, defaults to gpt-3.5-turbo

# Frontend URL (for email links)
FRONTEND_URL=http://localhost:3001    # Your frontend URL

# Digest settings (optional)
DIGEST_THRESHOLD=0.6                  # Default similarity threshold
```

## Gmail Setup

1. Enable 2-factor authentication on your Gmail account
2. Generate an App Password:
   - Go to Google Account settings
   - Security → 2-Step Verification → App passwords
   - Generate a password for "Mail"
   - Use this password as `EMAIL_PASSWORD`

## Database Migration

The system will automatically run the new database migration (version 10) to add:
- New digest settings columns to users table
- Enhanced digest_log table with more metadata
- digest_email_summaries table for storing AI-generated summaries

## API Endpoints Added

### Digest Settings
- `GET /api/digest/settings` - Get user's digest settings
- `PUT /api/digest/settings` - Update digest settings

### Digest History
- `GET /api/digest/history` - Get digest history
- `GET /api/digest/:id` - Get detailed digest by ID
- `POST /api/digest/test-email` - Send test digest email

## Frontend Pages Added

### New Pages
- `/digest/history` - View digest history
- `/digest/history/[id]` - View detailed digest
- Enhanced `/digest/settings` - Configure all digest options

### Settings Options
- Enable/disable digest
- Set delivery times (max 2 per day)
- Choose timezone
- Select email filter (all emails vs important only)
- Choose delivery method (email vs archive only)
- Test email delivery

## Usage

1. **Install dependencies**: `npm install`
2. **Set environment variables** as described above
3. **Start the server**: `npm run dev`
4. **Configure digest settings** at `/digest/settings`
5. **Test email delivery** using the "Test Email" button
6. **View digest history** at `/digest/history`

## Scheduler Behavior

The digest scheduler runs every minute and:
1. Checks each user's digest settings
2. Determines if it's time to send a digest based on configured times
3. Generates digest with AI summaries
4. Sends email if delivery is enabled
5. Archives digest for viewing in the app

## Email Template

The digest emails include:
- Professional HTML template with digest statistics
- Email summaries generated by ChatGPT
- Relevance scores for each email thread
- Links back to the web interface
- Responsive design for mobile viewing

## Troubleshooting

### Email Delivery Issues
- Verify Gmail App Password is correct
- Check that 2FA is enabled on Gmail account
- Review server logs for email delivery errors
- Test with the "Test Email" button in settings

### Summary Generation Issues
- Verify OpenAI API key is valid and has credits
- Check OpenAI API usage in their dashboard
- Review server logs for OpenAI API errors
- Summaries will fall back to basic email info if AI fails

### Database Issues
- Ensure database migrations run successfully on startup
- Check for any SQL constraint violations in logs
- Verify database file permissions
